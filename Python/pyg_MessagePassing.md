# MessagePassing Class in PyTorch Geometric

## Message Passing GNN çš„æ³›å¼

![image-20211208211243269](https://cdn.jsdelivr.net/gh/Zhangxin98/Note@main/img/202112082112436.png)



- xi(kâˆ’1)âˆˆRFè¡¨ç¤ºç¥ç»ç½‘ç»œçš„(kâˆ’1)å±‚ä¸­èŠ‚ç‚¹içš„èŠ‚ç‚¹è¡¨å¾
- ej,iâˆˆRD è¡¨ç¤ºä»èŠ‚ç‚¹jåˆ°èŠ‚ç‚¹içš„è¾¹çš„å±æ€§ä¿¡æ¯ã€‚
- â—»è¡¨ç¤º**å¯å¾®åˆ†**çš„ã€å…·æœ‰æ’åˆ—ä¸å˜æ€§ï¼ˆ**å‡½æ•°è¾“å‡ºç»“æœä¸è¾“å…¥å‚æ•°çš„æ’åˆ—æ— å…³**ï¼‰çš„å‡½æ•°, æ¯”å¦‚aggregation å‡½æ•°ã€‚æ¯”å¦‚sumï¼Œ mean, minç­‰å‡½æ•°å’Œè¾“å…¥çš„å‚æ•°é¡ºåºæ— å…³çš„å‡½æ•°ã€‚
- Î³ : **å¯å¾®åˆ†å¯å¯¼**çš„update å‡½æ•°ï¼Œæ¯”å¦‚MLPsï¼ˆå¤šå±‚æ„ŸçŸ¥å™¨ï¼‰
- Ï•: **å¯å¾®åˆ†å¯å¯¼**çš„message å‡½æ•°ï¼Œæ¯”å¦‚MLPsï¼ˆå¤šå±‚æ„ŸçŸ¥å™¨ï¼‰å’Œ linear Projectionç­‰
- **Note:**
    1. ç¥ç»ç½‘ç»œçš„ç”ŸæˆèŠ‚ç‚¹è¡¨å¾çš„æ“ä½œç§°ä¸ºèŠ‚ç‚¹åµŒå…¥ï¼ˆNode Embeddingï¼‰ï¼ŒèŠ‚ç‚¹è¡¨å¾ä¹Ÿå¯ä»¥ç§°ä¸ºèŠ‚ç‚¹åµŒå…¥ã€‚**è¿™é‡Œè€ƒè™‘èŠ‚ç‚¹åµŒå…¥åªä»£æŒ‡ç¥ç»ç½‘ç»œç”ŸæˆèŠ‚ç‚¹è¡¨å¾çš„æ“ä½œ**ã€‚
    2. æœªç»è¿‡è®­ç»ƒçš„å›¾ç¥ç»ç½‘ç»œç”Ÿæˆçš„èŠ‚ç‚¹è¡¨å¾è¿˜ä¸æ˜¯å¥½çš„èŠ‚ç‚¹è¡¨å¾ï¼Œå¥½çš„èŠ‚ç‚¹è¡¨å¾å¯ç”¨äºè¡¡é‡èŠ‚ç‚¹ä¹‹é—´çš„ç›¸ä¼¼æ€§ã€‚é€šè¿‡ç›‘ç£å­¦ä¹ å¯¹å›¾ç¥ç»ç½‘ç»œåšå¾ˆå¥½çš„è®­ç»ƒï¼Œå›¾ç¥ç»ç½‘ç»œæ‰å¯ä»¥ç”Ÿæˆå¥½çš„èŠ‚ç‚¹è¡¨å¾ã€‚æˆ‘ä»¬å°†åœ¨[ç¬¬5èŠ‚](https://notebooks.githubusercontent.com/view/5-åŸºäºå›¾ç¥ç»ç½‘ç»œçš„èŠ‚ç‚¹è¡¨å¾å­¦ä¹ .md)ä»‹ç»æ­¤éƒ¨åˆ†å†…å®¹ã€‚
    3. èŠ‚ç‚¹è¡¨å¾ä¸èŠ‚ç‚¹å±æ€§çš„åŒºåˆ†ï¼šéµå¾ªè¢«å¹¿æ³›ä½¿ç”¨çš„çº¦å®šï¼Œæ­¤æ¬¡ç»„é˜Ÿå­¦ä¹ æˆ‘ä»¬ä¹Ÿçº¦å®šï¼ŒèŠ‚ç‚¹å±æ€§`data.x`æ˜¯èŠ‚ç‚¹çš„ç¬¬0å±‚(GNNè¾“å…¥å±‚)èŠ‚ç‚¹è¡¨å¾ï¼Œç¬¬hå±‚çš„èŠ‚ç‚¹è¡¨å¾ç»è¿‡ä¸€æ¬¡çš„èŠ‚ç‚¹é—´ä¿¡æ¯ä¼ é€’äº§ç”Ÿç¬¬h+1å±‚çš„èŠ‚ç‚¹è¡¨å¾ã€‚ä¸è¿‡ï¼ŒèŠ‚ç‚¹å±æ€§ä¸å•æŒ‡`data.x`ï¼Œå¹¿ä¹‰ä¸Šå®ƒå°±æŒ‡èŠ‚ç‚¹çš„å±æ€§ï¼Œå¦‚èŠ‚ç‚¹çš„åº¦(in-degree, out-degree)ç­‰ã€‚

## MessagePassing çš„Base Class å‡½æ•°

Pytorch Geometric(PyG)æä¾›äº†MessagePassingåŸºç±»ï¼Œå®ƒå°è£…äº†â€œæ¶ˆæ¯ä¼ é€’â€çš„è¿è¡Œæµç¨‹ã€‚é€šè¿‡ç»§æ‰¿MessagePassingåŸºç±»ï¼Œå¯ä»¥æ–¹ä¾¿åœ°æ„é€ æ¶ˆæ¯ä¼ é€’å›¾ç¥ç»ç½‘ç»œã€‚æ„é€ ä¸€ä¸ªæœ€ç®€å•çš„æ¶ˆæ¯ä¼ é€’å›¾ç¥ç»ç½‘ç»œç±»ï¼Œæˆ‘ä»¬åªéœ€å®šä¹‰message()æ–¹æ³•ï¼ˆ ğœ™(..) ï¼‰ã€update()æ–¹æ³•ï¼ˆ ğ›¾(..) ï¼‰ï¼Œä»¥åŠä½¿ç”¨çš„æ¶ˆæ¯èšåˆæ–¹æ¡ˆï¼ˆaggr=â€addâ€ã€aggr=â€meanâ€æˆ–aggr=â€maxâ€ã€‚**MessagePassing Base Classä¸­è¿™é‡Œæœ€é‡è¦çš„3ä¸ªå‡½æ•°æ˜¯ï¼š**

- `MessagePassing.aggregate(...)`ï¼šç”¨äºå¤„ç†èšé›†åˆ°èŠ‚ç‚¹çš„ä¿¡æ¯çš„å‡½æ•°
- `MessagePassing.message(...)`ï¼šç”¨äºæ­å»ºä¼ é€åˆ° node içš„èŠ‚ç‚¹æ¶ˆæ¯ï¼Œç›¸å¯¹äºğœ™(..)å‡½æ•°
- `MessagePassing.update(aggr_out, ...)`: ç”¨äºæ›´æ–°èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œç›¸å¯¹äºğ›¾(..)

**ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨å‡½æ•°çš„è§£é‡Š:**

- `MessagePassing(aggr="add", flow="source_to_target", node_dim=-2)`:
    - `aggr`: aggregation functionèšåˆå‡½æ•°çš„é€‰é¡¹, å¯ä»¥ç”¨ (â€œaddâ€, â€œmeanâ€ or â€œmaxâ€)
    - `flow`: ä¿¡æ¯ä¼ é€’æ–¹å‘ (either â€œsource_to_targetâ€ or â€œtarget_to_sourceâ€)
    - `node_dim`ï¼šå®šä¹‰æ²¿ç€å“ªä¸ªç»´åº¦ä¼ æ’­ï¼Œé»˜è®¤å€¼ä¸º-2ï¼Œä¹Ÿå°±æ˜¯èŠ‚ç‚¹è¡¨å¾å¼ é‡ï¼ˆdata.x, Tensorï¼‰çš„å“ªä¸€ä¸ªç»´åº¦æ˜¯èŠ‚ç‚¹ç»´åº¦ã€‚èŠ‚ç‚¹è¡¨å¾å¼ é‡xå½¢çŠ¶ä¸º[num_nodes, num_features]ï¼Œå…¶ç¬¬0ç»´åº¦/columnsï¼ˆä¹Ÿæ˜¯ç¬¬-2ç»´åº¦ï¼‰æ˜¯èŠ‚ç‚¹ç»´åº¦(èŠ‚ç‚¹çš„ä¸ªæ•°)ï¼Œå…¶ç¬¬1ç»´åº¦ï¼ˆä¹Ÿæ˜¯ç¬¬-1ç»´åº¦ï¼‰æ˜¯èŠ‚ç‚¹è¡¨å¾ç»´åº¦ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¾ç½®node_dim=-2ã€‚
- `MessagePassing.propagate(edge_index, size=None, **kwargs)`:
    - `edge_index`: ä¸€ä¸ªmatrixå­˜æ”¾æ¯æ¡edge çš„ç´¢å¼•ä¿¡æ¯(èµ·å§‹å’Œç»ˆæ­¢çš„nodeçš„index)
    - `size`: åŸºäºéå¯¹ç§°çš„é‚»æ¥çŸ©é˜µè¿›è¡Œæ¶ˆæ¯ä¼ é€’ï¼ˆå½“å›¾ä¸ºäºŒéƒ¨å›¾æ—¶ï¼‰ï¼Œéœ€è¦ä¼ é€’å‚æ•°size=(N, M)ã€‚å¦‚æœsize=None, é»˜è®¤é‚»æ¥çŸ©é˜µæ˜¯å¯¹ç§°çš„
    - `**kwargs`ï¼šå›¾çš„å…¶ä»–ç‰¹å¾
- `MessagePassing.message(...)`ï¼š
    - é¦–å…ˆç¡®å®šè¦ç»™èŠ‚ç‚¹$i$ä¼ é€’æ¶ˆæ¯çš„è¾¹çš„é›†åˆï¼š
        - å¦‚æœ`flow="source_to_target"`ï¼Œåˆ™æ˜¯$(j,i)âˆˆE$çš„è¾¹çš„é›†åˆï¼›
        - å¦‚æœ`flow="target_to_source"`ï¼Œåˆ™æ˜¯$(i,j)âˆˆE$çš„è¾¹çš„é›†åˆã€‚
    - æ¥ç€ä¸ºå„æ¡è¾¹åˆ›å»ºè¦ä¼ é€’ç»™èŠ‚ç‚¹iiçš„æ¶ˆæ¯ï¼Œå³å®ç°$Ï•$å‡½æ•°ã€‚
    - `MessagePassing.message(...)`æ–¹æ³•å¯ä»¥æ¥æ”¶ä¼ é€’ç»™`MessagePassing.propagate(edge_index, size=None, **kwargs)`æ–¹æ³•çš„æ‰€æœ‰å‚æ•°ï¼Œæˆ‘ä»¬åœ¨`message()`æ–¹æ³•çš„å‚æ•°åˆ—è¡¨é‡Œå®šä¹‰è¦æ¥æ”¶çš„å‚æ•°ï¼Œä¾‹å¦‚æˆ‘ä»¬è¦æ¥æ”¶`x,y,z`å‚æ•°ï¼Œåˆ™æˆ‘ä»¬åº”å®šä¹‰`message(x,y,z)`æ–¹æ³•ã€‚
    - ä¼ é€’ç»™`propagate()`æ–¹æ³•çš„å‚æ•°ï¼Œå¦‚æœæ˜¯èŠ‚ç‚¹çš„å±æ€§çš„è¯ï¼Œå¯ä»¥è¢«æ‹†åˆ†æˆå±äºä¸­å¿ƒèŠ‚ç‚¹çš„éƒ¨åˆ†å’Œå±äºé‚»æ¥èŠ‚ç‚¹çš„éƒ¨åˆ†ï¼Œåªéœ€åœ¨å˜é‡ååé¢åŠ ä¸Š`_i`æˆ–`_j`ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„`meassage`æ–¹æ³•åŒ…å«å‚æ•°`x_i`ï¼Œé‚£ä¹ˆé¦–å…ˆ`propagate()`æ–¹æ³•å°†èŠ‚ç‚¹è¡¨å¾æ‹†åˆ†æˆä¸­å¿ƒèŠ‚ç‚¹è¡¨å¾å’Œé‚»æ¥èŠ‚ç‚¹è¡¨å¾ï¼Œæ¥ç€`propagate()`æ–¹æ³•è°ƒç”¨`message`æ–¹æ³•å¹¶ä¼ é€’ä¸­å¿ƒèŠ‚ç‚¹è¡¨å¾ç»™å‚æ•°`x_i`ã€‚è€Œå¦‚æœæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„`meassage`æ–¹æ³•åŒ…å«å‚æ•°`x_j`ï¼Œé‚£ä¹ˆ`propagate()`æ–¹æ³•ä¼šä¼ é€’é‚»æ¥èŠ‚ç‚¹è¡¨å¾ç»™å‚æ•°`x_j`ã€‚
    - æˆ‘ä»¬ç”¨iiè¡¨ç¤ºâ€œæ¶ˆæ¯ä¼ é€’â€ä¸­çš„ä¸­å¿ƒèŠ‚ç‚¹ï¼Œç”¨jjè¡¨ç¤ºâ€œæ¶ˆæ¯ä¼ é€’â€ä¸­çš„é‚»æ¥èŠ‚ç‚¹ã€‚
- `MessagePassing.aggregate(...)`ï¼š
    - å°†ä»æºèŠ‚ç‚¹ä¼ é€’è¿‡æ¥çš„æ¶ˆæ¯èšåˆåœ¨ç›®æ ‡èŠ‚ç‚¹ä¸Šï¼Œä¸€èˆ¬å¯é€‰çš„èšåˆæ–¹å¼æœ‰`sum`, `mean`å’Œ`max`ã€‚
- `MessagePassing.message_and_aggregate(...)`ï¼š
    - åœ¨ä¸€äº›åœºæ™¯é‡Œï¼Œé‚»æ¥èŠ‚ç‚¹ä¿¡æ¯å˜æ¢å’Œé‚»æ¥èŠ‚ç‚¹ä¿¡æ¯èšåˆè¿™ä¸¤é¡¹æ“ä½œå¯ä»¥èåˆåœ¨ä¸€èµ·ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨æ­¤æ–¹æ³•é‡Œå®šä¹‰è¿™ä¸¤é¡¹æ“ä½œï¼Œä»è€Œè®©ç¨‹åºè¿è¡Œæ›´åŠ é«˜æ•ˆã€‚
- `MessagePassing.update(aggr_out, ...)`:
    - ä¸ºæ¯ä¸ªèŠ‚ç‚¹iâˆˆViâˆˆVæ›´æ–°èŠ‚ç‚¹è¡¨å¾ï¼Œå³å®ç°Î³Î³å‡½æ•°ã€‚æ­¤æ–¹æ³•ä»¥`aggregate`æ–¹æ³•çš„è¾“å‡ºä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå¹¶æ¥æ”¶æ‰€æœ‰ä¼ é€’ç»™`propagate()`æ–¹æ³•çš„å‚æ•°ã€‚

## MessagePassing çš„Base Class å‡½æ•°

### propagate å‡½æ•°çš„è¾“å…¥

propagate å‡½æ•°çš„è¾“å…¥ æœ‰edge_index, x (node embedding matrix), ä»¥åŠå…¶ä»–è‡ªå®šä¹‰çš„è¾“å…¥å‚æ•°(degree, normä¹‹ç±»çš„)ã€‚å…¶ä¸­edge_indexçš„å‚¨å­˜å½¢å¼å¦‚ä¸‹

$$Edgeindex = \begin{matrix}[[0&0&1&4]\\\ [0&1&4&1]]\end{matrix}$$

å…¶ä¸­Edge_indexçš„shape = [2, amount of edge]. Edge_index[0]ç¬¬ä¸€è¡Œæ˜¯source nodeçš„indexï¼Œ Edge_index[1]ç¬¬äºŒè¡Œæ˜¯target nodeçš„index.

**Note**

1. å¦‚æœedge_index ç”¨ torch tensoræ¥å‚¨å­˜ï¼Œé‚£ä¹ˆpropagateå‡½æ•°ä¼šåˆ†åˆ«è°ƒç”¨message, aggregateçš„å‡½æ•°
2. å¦‚æœedge_index ç”¨ torch_sparseçš„SparseTensorç±»æ¥å‚¨å­˜ï¼Œé‚£ä¹ˆpropagateå‡½æ•°ä¼šè°ƒç”¨message_and_aggregateçš„å‡½æ•°è€Œä¸æ˜¯ä¸¤ä¸ªå•ç‹¬çš„å‡½æ•°
3. å½“edge_index, x(node embedding)è¾“å…¥åˆ°propagateåï¼Œå®ƒä¼šè‡ªåŠ¨é€šè¿‡ __collect__()å‡½æ•° æŠŠè¾“å…¥è§£æå¾—åˆ°ä»¥ä¸‹å‚æ•°:
    - å¦‚æœself.flow=â€source_to_targetâ€:
        - **x_i**: edge_indexçš„target nodeçš„indexåˆ—è¡¨(edge_index[1])å¯¹åº”çš„node embeddingå‘é‡åˆ—è¡¨ã€‚
            æ¯”å¦‚ edge_indexçš„target nodeåˆ—è¡¨æ˜¯ edge_index[1], length = E, è€Œnode embeddingçš„ç»´åº¦ä¸ºdim, é‚£ä¹ˆ x_i =x[edge_index[1]]æ˜¯edge_index[1]æ‰€å¯¹åº”çš„embeddingåˆ—è¡¨ï¼Œ x_içš„shape= [E, dim]ã€‚
            ä¸¾ä¸ªä¾‹å­å°±æ˜¯ target node çš„ç´¢å¼•åˆ—è¡¨æ˜¯ edge_index[1] = [0, 1, 2]è€Œ E=3, dim=2, é‚£ä¹ˆ x_i = [[0.5,0.6],[0.1,0.22],[0.2,0.3]]ã€‚x_ié‡Œé¢çš„æ¯ä¸€è¡Œåˆ†åˆ«å¯¹åº”target node 0, 1,2çš„node embeddingå‘é‡
        - **deg_i**: edge_indexçš„target nodeçš„indexåˆ—è¡¨å¯¹åº”çš„degreeåˆ—è¡¨ã€‚è¿™ä¸ªå’Œx_iåŒç†
        - **x_j**ï¼šedge_indexçš„source nodeçš„edge_index[0]åˆ—è¡¨å¯¹åº”çš„node embeddingå‘é‡åˆ—è¡¨ã€‚
        - **deg_j**: edge_indexçš„source nodeçš„edge_index[0]åˆ—è¡¨å¯¹åº”çš„degreeåˆ—è¡¨ã€‚è¿™ä¸ªå’Œx_jåŒç†
    - **å¦‚æœflow=â€target_to_sourceâ€ é‚£ä¹ˆæœ‰_ iåç¼€ä»£è¡¨source, _ jåç¼€ä»£è¡¨target node**
4. åœ¨å¾—åˆ°target nodeçš„edge_indexå’Œ å¯¹åº”çš„source nodeçš„node embedding vectorsä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠæ¯ä¸ªtarget nodeå¯¹åº”çš„æ‰€æœ‰node embeddingå‘é‡èšåˆä¸€èµ·å¾—åˆ°target nodeçš„ä¿¡æ¯é›†åˆç”¨äºæ­å»º messageäº†

### messageå‡½æ•°çš„è¾“å…¥

message å‡½æ•°è¾“å…¥ä¸€èˆ¬åŒ…æ‹¬: x_i, x_j, deg_i, deg_j, edge_indexä»¥åŠå…¶ä»–è‡ªå®šä¹‰çš„å‚æ•°è¾“å…¥

### aggregateå‡½æ•°çš„è¾“å…¥

aggregate å‡½æ•°è¾“å…¥é™¤äº†æœ‰ **inputs (æ¥è‡ªmessageå‡½æ•°çš„è¾“å…¥)** å¤– ä¸€èˆ¬è¿˜åŒ…æ‹¬: inputs, x_i, x_j, deg_i, deg_j, edge_indexä»¥åŠå…¶ä»–è‡ªå®šä¹‰çš„å‚æ•°è¾“å…¥ã€‚

### message_and_aggregate å‡½æ•°çš„è¾“å…¥

message_and_aggregate å‡½æ•°è¾“å…¥ ä¸€èˆ¬è¿˜åŒ…æ‹¬: x_i, x_j, deg_i, deg_j, edge_indexä»¥åŠå…¶ä»–è‡ªå®šä¹‰çš„å‚æ•°è¾“å…¥ã€‚

### update å‡½æ•°çš„è¾“å…¥

update å‡½æ•°è¾“å…¥åŒ…æ‹¬inputsä»¥åŠå…¶ä»–è‡ªå®šä¹‰çš„å‚æ•°è¾“å…¥ã€‚

